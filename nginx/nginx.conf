# =========================================================
#  Main /etc/nginx/nginx.conf  – core only, v-hosts live in conf.d/
# =========================================================

# 1️⃣  Master / worker basics
worker_processes  auto;        # 1 worker per vCPU visible to the container
pid /var/run/nginx.pid;        # (optional, but useful for systemd-less images)

events {
    worker_connections  4096;  # total = workers × 4096  (≈ 16 k on a 4-vCPU box)
}

# 2️⃣  HTTP layer
http {
    include       mime.types;
    default_type  application/octet-stream;

    # ── Performance ──
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65s;
    types_hash_max_size 4096;

    reset_timedout_connection on;   # drop dead sockets quickly
    server_names_hash_bucket_size 128;  # avoids rare long-hostname warnings

    # ── NEW: WebSocket helper ──
    map $http_upgrade $connection_upgrade {
        ''       close;    # header absent  → keep-alive close
        default  upgrade;  # any value      → upgrade
    }

    # ── NEW: log a notice when limit_req blocks traffic ──
    limit_req_log_level notice;

    # ── (optional) Geo/IP stub ──
    # geo $block_country {
    #     default 0;
    #     SA      0;   # South-Africa allowed
    #     US      1;   # example blocked country
    # }
    # if ($block_country) { return 444; }

    # ── Global security headers, rate-limiter zone ──
    include /etc/nginx/snippets/global_security.conf;

    # ── Virtual hosts ──
    include /etc/nginx/conf.d/*.conf;
}


# # HTTP - Redirect all traffic to HTTPS
# server {
#     listen 80;
#     server_name 192.168.100.151;

#     # Force HTTP to HTTPS redirection
#     return 301 https://$host$request_uri;
# }

# # HTTPS server configuration
# server {
#     listen 443 ssl;
#     server_name 192.168.100.151;

#     # SSL certificates
#     
#     

#     # SSL security settings
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_prefer_server_ciphers on;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
#     ssl_ecdh_curve secp384r1;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 1h;
# #    ssl_dhparam /etc/ssl/certs/dhparam.pem;  # This is a Diffie-Hellman parameter file, should be created


#     # HSTS (HTTP Strict Transport Security)
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

#     # Prevent content sniffing
#     add_header X-Content-Type-Options "nosniff" always;

#     # Prevent cross-site scripting attacks
#     add_header X-XSS-Protection "1; mode=block" always;

#     # Prevent clickjacking
#     add_header X-Frame-Options "SAMEORIGIN" always;

#     # Prevent content injection
#     add_header Referrer-Policy "no-referrer-when-downgrade" always;

#     # Prevent DNS prefetching on your domain
#     add_header X-DNS-Prefetch-Control "off" always;

#     # Allow only certain content types in response
# #    add_header Content-Security-Policy "default-src 'self';" always;

#     # Limit the size of client requests
#     client_max_body_size 500M;

#     # Proxy timeout and buffering settings
#     proxy_connect_timeout 1200s;
#     proxy_send_timeout 1200s;
#     proxy_read_timeout 1200s;

#     # Increase buffers for larger responses
#     proxy_buffers 16 4k;
#     proxy_buffer_size 2k;

#     # Media location
#     location /media/ {
#         alias /app/media/;
#     }

#     # Proxy settings
#     location / {
#         proxy_pass http://app:8000;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header Host $http_host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Port $server_port;
#         proxy_redirect off;
#     }
# }

# # HTTP - Accept only HTTP traffic (no redirection to HTTPS)
# server {
#     listen 80;
#     server_name 154.0.164.154;

#     client_max_body_size 500M;

#     # Optional: Increase timeouts at the server level
#     proxy_read_timeout 300s;
#     proxy_connect_timeout 300s;
#     proxy_send_timeout 300s;
#     send_timeout 300s;

#     # Proxy settings for HTTP traffic
#     location /media/ {
#         alias /app/media/;
#     }

#     location / {
#         proxy_pass http://app:8000;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header Host $http_host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Port $server_port;
#         proxy_redirect off;

# 	proxy_read_timeout 300s;
#         proxy_connect_timeout 300s;
#         proxy_send_timeout 300s;	
#     }
# }
