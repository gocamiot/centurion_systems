server {
    listen 443 ssl;
    http2  on;                               # HTTP/2 for speed
    server_name 192.168.100.151;;

    # TLS – certs

    # TLS – inherits protocols & stapling from global snippet
    # Prefer modern AEAD suites; drop DHE-RSA unless you really need it
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_ecdh_curve X25519:secp384r1;         # prefer X25519, keep P-384 fallback

    # Session settings (inherited + these)
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1h;

    # Request size
    client_max_body_size 500M;

    # Timeouts: 1200s (=20m) is very long; keep, but only if uploads/long SSE justify it
    proxy_connect_timeout  30s;              # initial connect
    proxy_send_timeout   1200s;              # long uploads
    proxy_read_timeout   1200s;              # long responses / streams

    # Buffers (defaults are usually fine; keep yours if you’ve tested with big payloads)
    proxy_buffers 16 4k;
    proxy_buffer_size 2k;

    # Static/media from host
    location /media/ { alias /app/media/; }

    # Blocklists, method filters, rate limit
    include /etc/nginx/snippets/location_security.conf;

    # Upstream proxy
    location / {
        proxy_pass http://app:8000;

        # Forward client identity
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host              $host;

        # If the app uses websockets later, this just works:
        proxy_http_version 1.1;
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         $connection_upgrade;

        proxy_redirect off;
    }
}
